{% extends "index.html" %}
{% load custom_filter %}
{% load static %}
{% block content %}

<style>
    input[type="radio"] {
    display: inline-block;
    visibility: visible;
    margin-right: 5px;

}
.payment-method label {
    margin-right: 10px;
}

</style>
<div class="menu-layer">
    <!-- loader start-->
    <div class="page-loader">
        <div class="wrapper">
            <div class="circle"></div>
            <div class="circle"></div>
            <div class="circle"></div>
            <div class="shadow"></div>
            <div class="shadow"></div>
            <div class="shadow"></div>
            <span>Loading</span>
        </div>
    </div>
    <!-- loader end-->

    <!-- header -->
  
    <!-- hero-section -->
    <section class="hero-section about checkout gap"
        style="background-image: url(https://bslthemes.com/html/quickeat/assets/img/background-3.png);">
        <div class="container">
            <div class="row align-items-center mt-5">
                <ul class="crumbs d-flex" data-aos="fade-up" data-aos-delay="200" data-aos-duration="300">
                    <li><a href="{% url 'home:home-page' %}">Home</a></li>
                    <li><a href="{% url 'restaurant:restaurant' %}"><i class="fa-solid fa-right-long"></i>Restaurants </a></li>
                    <!-- <li><a href="{% url 'restaurant:restaurant' %}"><i class="fa-solid fa-right-long"></i>Restaurant
                            Ð¡ard</a></li> -->
                    <li class="two"><a href="javascript:void(0)"><i class="fa-solid fa-right-long"></i>Checkout</a>
                    </li>
                </ul>
                <div class="col-lg-12">
                    <div class="about-text pricing-table">
                        <h2 data-aos="fade-up" data-aos-delay="300" data-aos-duration="400">Checkout</h2>
                        <p data-aos="fade-up" data-aos-delay="400" data-aos-duration="500">Sit amet nisl purus in mollis
                            nunc sed id semper. Condimentum id venenatis a condimentum vitae sapien pellentesque.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- checkout-order -->
    <section class="gap">
        <div class="container">
            <div class="row">
                <div class="popup-overlay" style="display: none; ">
                    <div class="popup-content py-4" style="background-image: url(/static/images/background-1.png);object-fit: cover;">
                        <h4 class="popup-message"></h4>
                        <button class="popup-close btn btn-secondary ">Close</button>
                    </div>
                </div>
                <div class="col-xl-5 col-lg-12" data-aos="flip-up" data-aos-delay="200" data-aos-duration="300">
                    <div class="checkout-order">
                        <div class="title-checkout">
                            <h2>Your order:</h2>
                            <h6>{{ cart|length }}</h6>
                        </div>
                        
                        <div class="banner-wilmington">
                            <img alt="logo" src="{% if order.restaurant.logo %}{{order.restaurant.logo.url}}{% else %}{% static 'images/order-easy.png' %}{% endif %}" class="img-fluid mx-2" style="width: 120px; height: 100px; object-fit: cover;">
                            <div class="d-block">
                                <span>Restaurant:</span> 
                                <h6> {{order.restaurant.title}}</h6>
                            </div>
                        </div>
                        
                        <ul>
                            {% for item in cart %}
                                <li class="price-list my-2">
                                    {% comment %} <i class="closeButton fa-solid fa-xmark"></i> {% endcomment %}
                                    <div class="counter-container">
                                        <div class="counter-food">
                                            <img alt="food"class="mx-2" src="{% if item.image %}{{item.image}}{% else %}{% static 'images/order-easy.png' %}{% endif %}" style="width: 106px; height: 69px; object-fit: cover; border-radius: 4px;">
                                            <div class="food-details">
                                                <h5>{{ item.title }}</h5>
                                                <!-- <h3>NZ${{ item.price }}</h3> -->
                                            </div>
                                        </div>
                                        <div class="price">
                                            <h3>${{ item.price }}</h3>
                                        </div>
                                    </div>                                    
                                    <div class="price">
                                        <div class="d-flex py-auto my-auto">
                                            <span style="padding-top: 10px; padding-right: 10px;">Sum</span>
                                            <h2>${{ item.total }}</h2>
                                        </div>
                                        <div class="d-flex">
                                            <div class="qty-input d-flex">
                                                <span>Quantity</span>
                                                {% comment %} <button class="qty-count qty-count--minus" data-action="minus" type="button">-</button> {% endcomment %}
                                                <input class="product-qty" type="number" name="product-qty" min="0" value="{{ item.quantity }}" readonly>
                                                {% comment %} <button class="qty-count qty-count--add" data-action="add" type="button">+</button> {% endcomment %}
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                        
                        <div class="totel-order">
                            <span>Total order:</span>
                            <h5>${{ total }}</h5>
                        </div>

                        <div class="totel-delivery">
                            <span>Delivery Charge:</span>
                            <h5>${{ order.charge }}</h5>
                        </div>

                        {% if order.voucher %}
                            <div class="totel-voucher">
                                <span>Voucher Applied:</span>
                                <h5>-${{ order.voucher.discount }}</h5>
                            </div>
                        {% endif %}

                        <div class="totel-price">
                            <span>To pay:</span>
                            <h2>${{ order.total|floatformat:2 }}</h2>
                        </div>
                    </div>
                </div>
                <div class="offset-xl-1 col-xl-6 col-lg-12" data-aos="flip-up" data-aos-delay="300" data-aos-duration="400">
                    <form method="POST" class="checkout-form" id="checkout-form" autocomplete="off">
                        {% csrf_token %}
                        <h4>Buyer information</h4>
                        <input type="hidden" name="oid" value="{{ order.id }}" required>
                        <input type="text" name="first_name" placeholder="First Name" {% if order.fname %} value="{{ order.fname }}" readonly {% endif %} required autocomplete="new-password">
                        <input type="text" name="last_name" placeholder="Last Name" {% if order.lname %} value="{{ order.lname }}" readonly {% endif %} required autocomplete="new-password">
                        <div class="row">
                            <div class="col-lg-6">
                                <input class="email-input" type="email" name="email" placeholder="E-mail" {% if order.email %} value="{{ order.email }}" readonly {% endif %} required autocomplete="new-password">
                            </div>
                            <div class="col-lg-6">
                                <input type="number" name="phone" placeholder="Phone" {% if order.phone %} value="{{ order.phone }}" readonly {% endif %} required autocomplete="new-password">
                            </div>
                        </div>
                        <h4 class="two">Delivery details</h4>
                        <input type="text" id="location-input-3" name="address" placeholder="Address" value="{{ user_address.add }}" required autocomplete="new-password">
                        <button type="button" id="use-location-btn" class=" button-2  lh-lg rounded-4 mt-2 px-2" style="display:none;">Use My Current Location</button>
                        {% comment %} <textarea name="address" id="daddress" rows="10" cols="12" placeholder="Address" required></textarea> {% endcomment %}
                        <textarea name="instructions" id="instructions" rows="10" cols="12" placeholder="Special Instructions"></textarea>
                        <select class="doption-css Advice" name="otype" id="doptions" required>
                            <option value="Delivery" {% if order.otype == "Delivery" %}selected{% endif %}>Delivery</option>
                            <option value="Pickup" {% if order.otype == "Pickup" %}selected{% endif %}>Pickup</option>
                            {% comment %} <option value="Schedule" {% if order.otype == "Schedule" %}selected{% endif %}>Schedule</option> {% endcomment %}
                        </select>
                        <div class="payment-method mt-5">
                            <h4 class="two">Payment Method</h4>
                            <label>
                                Pay with Cash
                            </label>
                                <input type="radio" name="payment_method" value="Cash" {% if order.payment_method == "Cash" or not order.payment_method %}checked{% endif %}>
                            <!-- <label>
                                <input type="radio" name="payment_method" value="Card" {% if order.payment_method == "Card" %}checked{% endif %}>
                                Pay with Card
                            </label>
                            <label>
                                <input type="radio" name="payment_method" value="Other" {% if order.payment_method == "Other" %}checked{% endif %}>
                                Other
                            </label> -->
                        </div>

                        <button type="submit" id="checkout_button" name="place_order" class="button-price">Place Order</button>
                        <!-- <input type="text" name="street" placeholder="Street">
                        <div class="row">
                            <div class="col-lg-6">
                                <input type="text" name="house_number" placeholder="House number">
                            </div>
                            <div class="col-lg-6">
                                <input type="number" name="apartment_number" placeholder="Apartment number">
                                <span>*dispensable</span>
                            </div>
                        </div>
                        <input type="text" name="order_type" value="Delivery"> -->

                        <!-- <h4 class="two">Payment method</h4>
                        <div class="nav nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                            <button class="nav-link active" id="v-pills-home-tab" data-bs-toggle="pill"
                                data-bs-target="#v-pills-home" type="button" role="tab" aria-controls="v-pills-home"
                                aria-selected="true">Card</button>
                            <button class="nav-link" id="v-pills-profile-tab" data-bs-toggle="pill"
                                data-bs-target="#v-pills-profile" type="button" role="tab"
                                aria-controls="v-pills-profile" aria-selected="false">Cash</button>
                       </div>
                        <div class="tab-content" id="v-pills-tabContent">

                            <div class="tab-pane fade show active" id="v-pills-home" role="tabpanel"
                                aria-labelledby="v-pills-home-tab">
                                <label>
                                    <input type="radio" name="test" value="small" checked>
                                    <img alt="checkbox-img"
                                        src="https://bslthemes.com/html/quickeat/assets/img/checkbox-1.png">
                                </label>

                                <label>
                                    <input type="radio" name="test" value="big">
                                    <img alt="checkbox-img"
                                        src="https://bslthemes.com/html/quickeat/assets/img/checkbox-2.png">
                                </label>
                                <label>
                                    <input type="radio" name="test" value="big">
                                    <img alt="checkbox-img"
                                        src="https://bslthemes.com/html/quickeat/assets/img/checkbox-3.png">
                                </label>
                                <input type="number" name="Name" placeholder="Card number">
                                <div class="row">
                                    <div class="col-lg-6">
                                        <input type="text" name="E-mail" placeholder="Expiration Date">
                                    </div>
                                    <div class="col-lg-6">
                                        <input type="password" placeholder="CVV">
                                    </div>
                                </div>
                                <label class="checkbox-one">Save my payments details for future purchases
                                    <input type="checkbox" checked="checked">
                                    <span class="checkmark"></span>
                                </label>

                                <div class="tab-pane fade" id="v-pills-profile" role="tabpanel"
                                    aria-labelledby="v-pills-profile-tab">

                                </div>


                            </div>
                        </div> -->
                        <!-- <button class="button-price">Send</button> -->
                         
                    </form>
                </div>
            </div>
        </div>
    </section>
    <!-- footer -->
   
    <!-- bslthemes.com buttons html begin -->
    <div class="bsl-popup" data-theme="quickeat" data-category="html">
        <div class="bsl-popup__buttons"></div>
        <div class="bsl-popup__content bsl-popup__content-related">
            <div class="bsl-popup__menu"></div>
            <div class="bsl-popup__tabs">
                <div class="bsl-popup__tab bsl-popup__tab-demo"></div>
                <div class="bsl-popup__tab bsl-popup__tab-all"></div>
                <div class="bsl-popup__tab bsl-popup__tab-related"></div>
                <div class="bsl-popup__tab bsl-popup__tab-version"></div>
            </div>
        </div>
        <div class="bsl-popup__content bsl-popup__content-help"></div>
    </div>
    <!-- bslthemes.com buttons html end -->

    <!-- bslthemes.com buttons assets begin -->

</body>
{% endblock %}
{% block script_js %}
<script>
	function initAutocomplete() {
		var input = document.getElementById('location-input-2');
		var autocomplete = new google.maps.places.Autocomplete(input);
		autocomplete.setFields(['address_components', 'geometry', 'name']);
		autocomplete.addListener('place_changed', function () {
			var place = autocomplete.getPlace();
			var address = place.name;
			var latitude = place.geometry.location.lat();
			var longitude = place.geometry.location.lng();
			$('#address-2').val(address);
			$('#latitude-2').val(latitude);
			$('#longitude-2').val(longitude);
            $('#location-form-2').attr('action',"{% url 'home:checkout' %}")
			$('#location-form-2').submit();
		});
	}
	google.maps.event.addDomListener(window, 'load', initAutocomplete);
</script>
<script>
    $('#checkout-form #location-input-3').on('keyup keypress', function(e) {
        var keyCode = e.keyCode || e.which;
        if (keyCode === 13) { 
            e.preventDefault();
            return false;
        }
    });
	function initAutocomplete() {
		let input = document.getElementById('location-input-3');
		let autocomplete = new google.maps.places.Autocomplete(input);
        let isPlaceSelected = false; 
        let useLocationBtn = $('#use-location-btn');
		autocomplete.setFields(['address_components', 'geometry', 'name']);
		autocomplete.addListener('place_changed', function () {
			let place = autocomplete.getPlace();
            if (!place.geometry) {
                input.value = ''; 
                useLocationBtn.show()
                isPlaceSelected = false;
                alert("Please select an address from the suggestions.");
                return;
            }
            isPlaceSelected = true
			let address = place.name;
			let latitude = place.geometry.location.lat();
			let longitude = place.geometry.location.lng();
			let location = $('#location-input-3').val()
			$('#address-2').val(address);
			$('#latitude-2').val(latitude);
			$('#longitude-2').val(longitude);
			$('#location-input-2').val(location);
            $.ajax({
                url: '{% url "home:update_user_address" %}',  
                type: 'POST',
                data: {
                    'orderId':'{{order.id}}',
                    'location': location,
                    'address': address,
                    'latitude': latitude,
                    'longitude': longitude,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'  
                },
                success: function (response) {
                    console.log('User address updated successfully');
                    calculateMatrixDistance(latitude, longitude, "{{order.restaurant.latitude}}", "{{order.restaurant.longitude}}", location, "{{order.restaurant.address}}", function(distance) {
                        console.log("final distance", distance.toFixed(2) + " km");
                        if (distance.toFixed(2) != "NaN") {
                            localStorage.setItem('rdistance'+"{{order.restaurant.id}}", Math.ceil(distance.toFixed(2)));
                            let orderOPS = $('#doptions').val()
                            if (orderOPS == "Delivery") {
                                if (distance > 15) {
                                    console.log($('#doptions').find('option[value="Pickup"]'))
                                    $('#doptions').find('option[value="Pickup"]').attr('selected', true);
                                    $('#doptions').val("Pickup");
                                    $('#location-input-3').hide()
                                    $('#location-input-3').removeAttr('required')
                                    $(".popup-overlay").show();
                                    $(".popup-message").html(`<p>Delivery is not available for distances greater than 15 km.</p><p> You can Pickup your order from {{order.restaurant.title}}.</p>`);
                                    return;
                                }
                                $('#location-input-3').show()
                                $('#location-input-3').attr('required', true);
                                {% if not user_address %}
                                $('#location-input-3').val('')
                                {% endif %}
                            }
                            else{
                                $('#location-input-3').hide()
                                $('#location-input-3').removeAttr('required')
                            }
                            $.ajax({
                                url: '{% url "home:update_dtype" %}',
                                method: 'POST',
                                data: {
                                    csrfmiddlewaretoken: '{{ csrf_token }}',
                                    'order_type': $('#doptions').val(),
                                    'oid': "{{order.id}}",
                                    'rdistance': Math.ceil(distance.toFixed(2))
                                },
                                success: function (res) {
                                    var order = JSON.parse(res['order'])[0]['fields'];
                                    $('.totel-delivery').find('h5').text('$'+order['charge']);
                                    $('.totel-price').find('h2').text('$'+order['total']);
                                    $('#doptions').find('option[value="'+order['otype']+'"]').attr('selected', true);
                                    $('#doptions').val(order['otype']);
                                    //document.getElementById('location-form-2').action = "{% url 'home:checkout' %}"
                                    //document.getElementById('location-form-2').submit();
                                }
                            });
                        }
                        else {
                            $.ajax({
                                url: '{% url "home:update_dtype" %}',
                                method: 'POST',
                                data: {
                                    csrfmiddlewaretoken: '{{ csrf_token }}',
                                    'order_type': 'Pickup',
                                    'oid': "{{order.id}}",
                                    'rdistance': 0
                                },
                                success: function (res) {
                                    if (res['status'] == 'success') {
                                        var order = JSON.parse(res['order'])[0]['fields'];
                                        $('.totel-delivery').find('h5').text('$'+order['charge']);
                                        $('.totel-price').find('h2').text('$'+order['total']);
                                        $('#doptions').find('option[value="'+order['otype']+'"]').attr('selected', true);
                                        $('#doptions').val(order['otype']);
                                        $('#location-input-3').hide()
                                        $('#location-input-3').removeAttr('required')
                                    }
                                }
                            });
                        }
                    })
                },
                error: function (xhr, status, error) {
                    console.error('Error updating user address:', error);
                }
            });
		});
        
        input.addEventListener('focusout', function() {
            setTimeout(function() {
                console.log(isPlaceSelected)
                if (!isPlaceSelected) {
                    input.value = '';
                    useLocationBtn.show()
                    isPlaceSelected = true;
                    alert("Please select a valid address from the suggestions.");
                }
         }, 200); 
        });
        input.addEventListener('input', function() {
            isPlaceSelected = false;
        });
        useLocationBtn.on('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    let latitude = position.coords.latitude;
                    let longitude = position.coords.longitude;
                    console.log(latitude,longitude)
                    let geocoder = new google.maps.Geocoder();
                    let latlng = { lat: latitude, lng: longitude };
                    geocoder.geocode({ location: latlng }, function(results, status) {
                        if (status === "OK") {
                            if (results[0]) {
                                var location = results[0].formatted_address;
                                input.value = location;
                                useLocationBtn.hide()  // Hide the button
                                document.getElementById('address-2').value = location;
                                document.getElementById('latitude-2').value = latitude;
                                document.getElementById('longitude-2').value = longitude;
                                document.getElementById('location-input-2').value = location;
                                $.ajax({
                                    url: '{% url "home:update_user_address" %}',  
                                    type: 'POST',
                                    data: {
                                        'orderId':'{{order.id}}',
                                        'location': location,
                                        'address': location,
                                        'latitude': latitude,
                                        'longitude': longitude,
                                        'csrfmiddlewaretoken': '{{ csrf_token }}'  
                                    },
                                    success: function (response) {
                                        console.log('User address updated successfully');
                                        calculateMatrixDistance(latitude, longitude, "{{order.restaurant.latitude}}", "{{order.restaurant.longitude}}", location, "{{order.restaurant.address}}", function(distance) {
                                            console.log("final distance", distance.toFixed(2) + " km");
                                            if (distance.toFixed(2) != "NaN") {
                                                localStorage.setItem('rdistance'+"{{order.restaurant.id}}", Math.ceil(distance.toFixed(2)));
                                                let orderOPS = $('#doptions').val()
                                                if (orderOPS == "Delivery") {
                                                    if (distance > 15) {
                                                        console.log($('#doptions').find('option[value="Pickup"]'))
                                                        $('#doptions').find('option[value="Pickup"]').attr('selected', true);
                                                        $('#doptions').val("Pickup");
                                                        $('#location-input-3').hide()
                                                        useLocationBtn.hide()
                                                        $('#location-input-3').removeAttr('required')
                                                        $(".popup-overlay").show();
                                                        $(".popup-message").html(`<p>Delivery is not available for distances greater than 15 km.</p><p> You can Pickup your order from {{order.restaurant.title}}.</p>`);
                                                        return;
                                                    }
                                                    $('#location-input-3').show()
                                                    $('#location-input-3').attr('required', true);
                                                    {% if not user_address %}
                                                    $('#location-input-3').val('')
                                                    {% endif %}
                                                }
                                                else{
                                                    $('#location-input-3').hide()
                                                    useLocationBtn.hide()
                                                    $('#location-input-3').removeAttr('required')
                                                }
                                                $.ajax({
                                                    url: '{% url "home:update_dtype" %}',
                                                    method: 'POST',
                                                    data: {
                                                        csrfmiddlewaretoken: '{{ csrf_token }}',
                                                        'order_type': $('#doptions').val(),
                                                        'oid': "{{order.id}}",
                                                        'rdistance': Math.ceil(distance.toFixed(2))
                                                    },
                                                    success: function (res) {
                                                        var order = JSON.parse(res['order'])[0]['fields'];
                                                        $('.totel-delivery').find('h5').text('$'+order['charge']);
                                                        $('.totel-price').find('h2').text('$'+order['total']);
                                                        $('#doptions').find('option[value="'+order['otype']+'"]').attr('selected', true);
                                                        $('#doptions').val(order['otype']);
                                                        //document.getElementById('location-form-2').action = "{% url 'home:checkout' %}"
                                                        //document.getElementById('location-form-2').submit();
                                                    }
                                                });
                                            }
                                            else {
                                                $.ajax({
                                                    url: '{% url "home:update_dtype" %}',
                                                    method: 'POST',
                                                    data: {
                                                        csrfmiddlewaretoken: '{{ csrf_token }}',
                                                        'order_type': 'Pickup',
                                                        'oid': "{{order.id}}",
                                                        'rdistance': 0
                                                    },
                                                    success: function (res) {
                                                        if (res['status'] == 'success') {
                                                            var order = JSON.parse(res['order'])[0]['fields'];
                                                            $('.totel-delivery').find('h5').text('$'+order['charge']);
                                                            $('.totel-price').find('h2').text('$'+order['total']);
                                                            $('#doptions').find('option[value="'+order['otype']+'"]').attr('selected', true);
                                                            $('#doptions').val(order['otype']);
                                                            $('#location-input-3').hide()
                                                            useLocationBtn.hide()
                                                            $('#location-input-3').removeAttr('required')
                                                        }
                                                    }
                                                });
                                            }
                                        })
                                    },
                                    error: function (xhr, status, error) {
                                        console.error('Error updating user address:', error);
                                    }
                                });

                            } else {
                                alert("No results found for your location.");
                            }
                        } else {
                            alert("Geocoder failed due to: " + status);
                        }
                    });
                }, function() {
                    alert("Geolocation failed. Please allow location access.");
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        });
    
	}
	google.maps.event.addDomListener(window, 'load', initAutocomplete);

</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        if("{{order.otype}}" == "Delivery"){
            $('#location-input-3').show()
            $('#location-input-3').attr('required', true);
        }else{
            $('#location-input-3').hide()
            $('#location-input-3').removeAttr('required')
        }
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                let userLat = position.coords.latitude;
                let userLon = position.coords.longitude;
                let useraddress = {{ user_address|default:"null" |safe }};
                if(useraddress){
                    userLat = useraddress.lat
                    userLon = useraddress.long;
                    useraddress = useraddress.add;
                }
                calculateMatrixDistance(userLat,userLon, "{{order.restaurant.latitude}}", "{{order.restaurant.longitude}}", useraddress, "{{order.restaurant.address}}", function(distance) {
                    
                    if (distance.toFixed(2) != "NaN") {
                        localStorage.setItem('rdistance'+"{{order.restaurant.id}}", Math.ceil(distance.toFixed(2)));
                        var resid = "{{order.restaurant.id}}";
                        var distance = parseFloat(localStorage.getItem('rdistance'+resid));
                        if (distance > 15) {
                            $('#doptions').find('option[value="Pickup"]').attr('selected', true);
                            $('#location-input-3').hide()
                            $('#location-input-3').removeAttr('required')
                        }
                        $.ajax({
                            url: '{% url "home:update_dtype" %}',
                            method: 'POST',
                            data: {
                                csrfmiddlewaretoken: '{{ csrf_token }}',
                                'order_type': $('#doptions').val(),
                                'oid': "{{order.id}}",
                                'rdistance': Math.ceil(distance.toFixed(2))
                            },
                            success: function (res) {
                                if (res['status'] == 'success') {
                                    var order = JSON.parse(res['order'])[0]['fields'];
                                    $('.totel-delivery').find('h5').text('$'+order['charge']);
                                    $('.totel-price').find('h2').text('$'+order['total']);
                                    $('#doptions').find('option[value="'+order['otype']+'"]').attr('selected', true);
                                    $('#doptions').val(order['otype']);
                                }
                            }
                        });
                    }
                    else {
                        $.ajax({
                            url: '{% url "home:update_dtype" %}',
                            method: 'POST',
                            data: {
                                csrfmiddlewaretoken: '{{ csrf_token }}',
                                'order_type': 'Pickup',
                                'oid': "{{order.id}}",
                                'rdistance': 0
                            },
                            success: function (res) {
                                if (res['status'] == 'success') {
                                    var order = JSON.parse(res['order'])[0]['fields'];
                                    $('.totel-delivery').find('h5').text('$'+order['charge']);
                                    $('.totel-price').find('h2').text('$'+order['total']);
                                    $('#doptions').find('option[value="'+order['otype']+'"]').attr('selected', true);
                                    $('#doptions').val(order['otype']);
                                    $('#location-input-3').hide()
                                    $('#location-input-3').removeAttr('required')
                                }
                            }
                        });
                    }
                })
            })
        }
    });
    $('body').on("change", "#doptions", function() {
        console.log("hyyy")
        var option = $(this).val();
        var resid = "{{order.restaurant.id}}";
        var distance = parseFloat(localStorage.getItem('rdistance'+resid));
        console.log(distance, "distance")
        if (option == "Delivery") {
			if (distance > 15) {
                console.log($('#doptions').find('option[value="Pickup"]'))
                $('#doptions').find('option[value="Pickup"]').attr('selected', true);
                $(this).val("Pickup");
				$(".popup-overlay").show();
                $(".popup-message").html(`<p>Delivery is not available for distances greater than 15 km.</p><p> You can Pickup your order from {{order.restaurant.title}}.</p>`);
                return;
			}
            $('#location-input-3').show()
            $('#location-input-3').attr('required', true);
            {% if not user_address %}
            $('#location-input-3').val('')
            {% endif %}
        }
        else{
            $('#location-input-3').hide()
            $('#location-input-3').removeAttr('required')
        }
        localStorage.setItem('order_type', option);
        $.ajax({
            url: '{% url "home:update_dtype" %}',
            method: 'POST',
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                'order_type': option,
                'oid': "{{order.id}}",
                'rdistance': distance
            },
            success: function (res) {
                if (res['status'] == 'success') {
                    var order = JSON.parse(res['order'])[0]['fields'];
                    $('.totel-delivery').find('h5').text('$'+order['charge']);
                    $('.totel-price').find('h2').text('$'+order['total']);
                    $('#doptions').find('option[value="'+order['otype']+'"]').attr('selected', true);
                    $('#doptions').val(order['otype']);
                }
            }
        });
    });
    $(".popup-close").on("click", function () {
        $(".popup-overlay").hide();
    });
</script>
{% endblock %}